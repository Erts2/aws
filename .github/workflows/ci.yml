name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  github-super-linter:
    name: ðŸ” GitHub Super Linter
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Super Linter
      uses: github/super-linter@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_ALL_CODEBASE: false
        VALIDATE_JAVASCRIPT_ES: true
        VALIDATE_JSON: true
        VALIDATE_YAML: true
        VALIDATE_DOCKER: true
        VALIDATE_MARKDOWN: true

  build-and-test:
    name: ðŸ³ Docker Build & Test
    needs: github-super-linter
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker images
      run: |
        docker compose build
        
    - name: Start services
      run: |
        docker compose up -d
        
    - name: Wait for services to be ready
      run: |
        echo "Waiting for services to start..."
        sleep 10
        
    - name: Check if services are running
      run: |
        docker compose ps
        
    - name: Run client tests
      run: |
        docker compose exec -T client npm test -- --watchAll=false --ci
        
    - name: Check service health
      run: |
        # Kontrollime, et teenused on kÃ¤ivitatud
        docker compose ps | grep -q "Up" || exit 1
        
    - name: Stop services
      if: always()
      run: |
        docker compose down
        
    - name: Build production Docker images
      if: success()
      run: |
        docker build -t ${{ secrets.DOCKER_ID }}/multi-client ./client
        docker build -t ${{ secrets.DOCKER_ID }}/multi-nginx ./nginx
        docker build -t ${{ secrets.DOCKER_ID }}/multi-server ./server
        docker build -t ${{ secrets.DOCKER_ID }}/multi-worker ./worker
        
    - name: Login to Docker Hub
      if: success()
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_ID }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Push images to Docker Hub
      if: success()
      run: |
        docker push ${{ secrets.DOCKER_ID }}/multi-client
        docker push ${{ secrets.DOCKER_ID }}/multi-nginx
        docker push ${{ secrets.DOCKER_ID }}/multi-server
        docker push ${{ secrets.DOCKER_ID }}/multi-worker

  sonarcloud:
    name: ðŸ“Š SonarCloud Analysis
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # SonarCloud vajab tÃ¤ielikku git ajalugu
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install client dependencies
      working-directory: ./client
      run: npm ci
      
    - name: Install server dependencies
      working-directory: ./server
      run: npm ci
      
    - name: Install worker dependencies
      working-directory: ./worker
      run: npm ci
      
    - name: SonarCloud Scan
      uses: SonarSource/sonarqube-scan-action@v5.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
          -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
          -Dsonar.sources=.
          -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

